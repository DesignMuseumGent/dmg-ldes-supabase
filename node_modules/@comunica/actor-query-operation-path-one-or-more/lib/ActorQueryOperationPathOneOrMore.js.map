{"version":3,"file":"ActorQueryOperationPathOneOrMore.js","sourceRoot":"","sources":["ActorQueryOperationPathOneOrMore.ts"],"names":[],"mappings":"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","sourcesContent":["import { ActorAbstractPath } from '@comunica/actor-abstract-path';\nimport { BindingsFactory } from '@comunica/bindings-factory';\nimport type { IActorQueryOperationTypedMediatedArgs } from '@comunica/bus-query-operation';\nimport { ActorQueryOperation } from '@comunica/bus-query-operation';\nimport type { IQueryOperationResultBindings, Bindings, IQueryOperationResult, IActionContext } from '@comunica/types';\nimport { BufferedIterator, MultiTransformIterator, TransformIterator } from 'asynciterator';\nimport { Algebra } from 'sparqlalgebrajs';\n\nconst BF = new BindingsFactory();\n\n/**\n * A comunica Path OneOrMore Query Operation Actor.\n */\nexport class ActorQueryOperationPathOneOrMore extends ActorAbstractPath {\n  public constructor(args: IActorQueryOperationTypedMediatedArgs) {\n    super(args, Algebra.types.ONE_OR_MORE_PATH);\n  }\n\n  public async runOperation(operation: Algebra.Path, context: IActionContext): Promise<IQueryOperationResult> {\n    const distinct = await this.isPathArbitraryLengthDistinct(context, operation);\n    if (distinct.operation) {\n      return distinct.operation;\n    }\n\n    context = distinct.context;\n\n    const predicate = <Algebra.OneOrMorePath> operation.predicate;\n\n    if (operation.subject.termType !== 'Variable' && operation.object.termType === 'Variable') {\n      const objectVar = operation.object;\n      const starEval = await this.getObjectsPredicateStarEval(\n        operation.subject,\n        predicate.path,\n        objectVar,\n        operation.graph,\n        context,\n        false,\n      );\n      const variables = operation.graph.termType === 'Variable' ? [ objectVar, operation.graph ] : [ objectVar ];\n      return {\n        type: 'bindings',\n        bindingsStream: starEval.bindingsStream,\n        metadata: async() => ({ ...await starEval.metadata(), variables }),\n      };\n    }\n    if (operation.subject.termType === 'Variable' && operation.object.termType === 'Variable') {\n      // Get all the results of subjects with same predicate, but once, then fill in first variable for those\n      const single = ActorAbstractPath.FACTORY.createDistinct(\n        ActorAbstractPath.FACTORY\n          .createPath(operation.subject, operation.predicate.path, operation.object, operation.graph),\n      );\n      const results = ActorQueryOperation.getSafeBindings(\n        await this.mediatorQueryOperation.mediate({ context, operation: single }),\n      );\n      const subjectVar = operation.subject;\n      const objectVar = operation.object;\n\n      const termHashes = {};\n\n      const bindingsStream: MultiTransformIterator<Bindings, Bindings> = new MultiTransformIterator(\n        results.bindingsStream,\n        {\n          multiTransform: (bindings: Bindings) => {\n            const subject = bindings.get(subjectVar);\n            const object = bindings.get(objectVar);\n            const graph = operation.graph.termType === 'Variable' ? bindings.get(operation.graph) : operation.graph;\n            return new TransformIterator<Bindings>(\n              async() => {\n                const it = new BufferedIterator<Bindings>();\n                await this.getSubjectAndObjectBindingsPredicateStar(\n                  subjectVar,\n                  objectVar,\n                  subject!,\n                  object!,\n                  predicate.path,\n                  graph!,\n                  context,\n                  termHashes,\n                  {},\n                  it,\n                  { count: 0 },\n                );\n                return it.transform<Bindings>({\n                  transform(item, next, push) {\n                    if (operation.graph.termType === 'Variable') {\n                      item = item.set(operation.graph, graph!);\n                    }\n                    push(item);\n                    next();\n                  },\n                });\n              }, { maxBufferSize: 128 },\n            );\n          },\n          autoStart: false,\n        },\n      );\n      const variables = operation.graph.termType === 'Variable' ?\n        [ subjectVar, objectVar, operation.graph ] :\n        [ subjectVar, objectVar ];\n      return {\n        type: 'bindings',\n        bindingsStream,\n        metadata: async() => ({ ...await results.metadata(), variables }),\n      };\n    }\n    if (operation.subject.termType === 'Variable' && operation.object.termType !== 'Variable') {\n      return <Promise<IQueryOperationResultBindings>> this.mediatorQueryOperation.mediate({\n        context,\n        operation: ActorAbstractPath.FACTORY.createPath(\n          operation.object,\n          ActorAbstractPath.FACTORY.createOneOrMorePath(\n            ActorAbstractPath.FACTORY.createInv(predicate.path),\n          ),\n          operation.subject,\n          operation.graph,\n        ),\n      });\n    }\n    // If (!sVar && !oVar)\n    const variable = this.generateVariable();\n    const results = ActorQueryOperation.getSafeBindings(await this.mediatorQueryOperation.mediate({\n      context,\n      operation: ActorAbstractPath.FACTORY.createPath(operation.subject, predicate, variable, operation.graph),\n    }));\n    const bindingsStream = results.bindingsStream.transform<Bindings>({\n      filter: item => operation.object.equals(item.get(variable)),\n      transform(item, next, push) {\n        const binding = operation.graph.termType === 'Variable' ?\n          BF.bindings([[ operation.graph, item.get(operation.graph)! ]]) :\n          BF.bindings();\n        push(binding);\n        next();\n      },\n    });\n    return {\n      type: 'bindings',\n      bindingsStream,\n      metadata: async() => ({\n        ...await results.metadata(),\n        variables: operation.graph.termType === 'Variable' ? [ operation.graph ] : [],\n      }),\n    };\n  }\n}\n\n"]}