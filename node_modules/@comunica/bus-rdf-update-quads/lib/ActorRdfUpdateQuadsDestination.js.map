{"version":3,"file":"ActorRdfUpdateQuadsDestination.js","sourceRoot":"","sources":["ActorRdfUpdateQuadsDestination.ts"],"names":[],"mappings":";;;AAAA,iHAAyF;AACzF,+DAA0F;AAM1F,+DAA4D;AAG5D,SAAgB,iBAAiB,CAAC,MAA2C,EAAE,EAAU;IAEvF,OAAO,MAAM,EAAE,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,8DAAmB,CAAC,eAAe,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC,CAAC;AAC5E,CAAC;AAHD,8CAGC;AAED,SAAgB,WAAW,CAAC,MAA6B;IACvD,MAAM,WAAW,GAAG,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,oCAAkB,CAAC,WAAW,CAAC,CAAC;IACvE,MAAM,EAAE,GAAG,MAAM,CAAC,OAAO,CAAC,GAAG,CAAmB,2CAAyB,CAAC,SAAS,CAAC,EAAE,GAAG,CAAC,WAAW,CAAC,CAAC;IACvG,IAAI,CAAC,EAAE,EAAE;QACP,OAAO,MAAM,CAAC;KACf;IACD,OAAO;QACL,GAAG,MAAM;QACT,gBAAgB,EAAE,iBAAiB,CAAC,MAAM,CAAC,gBAAgB,EAAE,EAAE,CAAC;QAChE,gBAAgB,EAAE,iBAAiB,CAAC,MAAM,CAAC,gBAAgB,EAAE,EAAE,CAAC;KACjE,CAAC;AACJ,CAAC;AAXD,kCAWC;AAED;;;;;GAKG;AACH,MAAsB,8BAA+B,SAAQ,yCAAmB;IACvE,KAAK,CAAC,IAAI,CAAC,MAA6B;QAC7C,OAAO,IAAI,CAAC;IACd,CAAC;IAEM,KAAK,CAAC,GAAG,CAAC,MAA6B;QAC5C,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;QAC9D,OAAO,MAAM,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,WAAW,CAAC,MAAM,CAAC,EAAE,MAAM,CAAC,OAAO,CAAC,CAAC;IAChF,CAAC;IAED;;;;;OAKG;IACO,KAAK,CAAC,SAAS,CACvB,WAA6B,EAC7B,MAA6B,EAC7B,OAAuB;QAEvB,MAAM,OAAO,GAAG,GAAkB,EAAE,CAAC,OAAO,CAAC,GAAG,CAAC;YAC/C,MAAM,CAAC,gBAAgB,CAAC,CAAC,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,EAAE;YACzF,MAAM,CAAC,gBAAgB,CAAC,CAAC,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,EAAE;YACzF,MAAM,CAAC,YAAY,CAAC,CAAC;gBACnB,WAAW,CAAC,YAAY,CACtB,MAAM,CAAC,YAAY,CAAC,MAAM,EAC1B,MAAM,CAAC,YAAY,CAAC,gBAAgB,EACpC,MAAM,CAAC,YAAY,CAAC,UAAU,CAC/B,CAAC,CAAC;gBACH,OAAO,CAAC,OAAO,EAAE;YACnB,MAAM,CAAC,YAAY,CAAC,CAAC;gBACnB,WAAW,CAAC,YAAY,CAAC,MAAM,CAAC,YAAY,CAAC,MAAM,EAAE,MAAM,CAAC,YAAY,CAAC,mBAAmB,CAAC,CAAC,CAAC;gBAC/F,OAAO,CAAC,OAAO,EAAE;SACpB,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE;YACX,cAAc;QAChB,CAAC,CAAC,CAAC;QACH,OAAO,EAAE,OAAO,EAAE,CAAC;IACrB,CAAC;CAQF;AA9CD,wEA8CC","sourcesContent":["import { FederatedQuadSource } from '@comunica/actor-rdf-resolve-quad-pattern-federated';\nimport { KeysRdfResolveQuadPattern, KeysRdfUpdateQuads } from '@comunica/context-entries';\nimport type { IActorTest } from '@comunica/core';\nimport type { IActionContext } from '@comunica/types';\nimport type * as RDF from '@rdfjs/types';\nimport type { AsyncIterator } from 'asynciterator';\nimport type { IActionRdfUpdateQuads, IActorRdfUpdateQuadsOutput } from './ActorRdfUpdateQuads';\nimport { ActorRdfUpdateQuads } from './ActorRdfUpdateQuads';\nimport type { IQuadDestination } from './IQuadDestination';\n\nexport function deskolemizeStream(stream: AsyncIterator<RDF.Quad> | undefined, id: string):\nAsyncIterator<RDF.Quad> | undefined {\n  return stream?.map(quad => FederatedQuadSource.deskolemizeQuad(quad, id));\n}\n\nexport function deskolemize(action: IActionRdfUpdateQuads): IActionRdfUpdateQuads {\n  const destination = action.context.get(KeysRdfUpdateQuads.destination);\n  const id = action.context.get<Map<any, string>>(KeysRdfResolveQuadPattern.sourceIds)?.get(destination);\n  if (!id) {\n    return action;\n  }\n  return {\n    ...action,\n    quadStreamInsert: deskolemizeStream(action.quadStreamInsert, id),\n    quadStreamDelete: deskolemizeStream(action.quadStreamDelete, id),\n  };\n}\n\n/**\n * A base implementation for rdf-update-quads events\n * that wraps around an {@link IQuadDestination}.\n *\n * @see IQuadDestination\n */\nexport abstract class ActorRdfUpdateQuadsDestination extends ActorRdfUpdateQuads {\n  public async test(action: IActionRdfUpdateQuads): Promise<IActorTest> {\n    return true;\n  }\n\n  public async run(action: IActionRdfUpdateQuads): Promise<IActorRdfUpdateQuadsOutput> {\n    const destination = await this.getDestination(action.context);\n    return await this.getOutput(destination, deskolemize(action), action.context);\n  }\n\n  /**\n   * Get the output of the given action on a destination.\n   * @param {IQuadDestination} destination A quad destination, possibly lazy.\n   * @param {IActionRdfUpdateQuads} action The action.\n   * @param {ActionContext} context Optional context data.\n   */\n  protected async getOutput(\n    destination: IQuadDestination,\n    action: IActionRdfUpdateQuads,\n    context: IActionContext,\n  ): Promise<IActorRdfUpdateQuadsOutput> {\n    const execute = (): Promise<void> => Promise.all([\n      action.quadStreamInsert ? destination.insert(action.quadStreamInsert) : Promise.resolve(),\n      action.quadStreamDelete ? destination.delete(action.quadStreamDelete) : Promise.resolve(),\n      action.deleteGraphs ?\n        destination.deleteGraphs(\n          action.deleteGraphs.graphs,\n          action.deleteGraphs.requireExistence,\n          action.deleteGraphs.dropGraphs,\n        ) :\n        Promise.resolve(),\n      action.createGraphs ?\n        destination.createGraphs(action.createGraphs.graphs, action.createGraphs.requireNonExistence) :\n        Promise.resolve(),\n    ]).then(() => {\n      // Return void\n    });\n    return { execute };\n  }\n\n  /**\n   * Get a destination instance for the given context.\n   * @param {ActionContext} context Optional context data.\n   * @return {Promise<IQuadSource>} A promise that resolves to a destination.\n   */\n  protected abstract getDestination(context: IActionContext): Promise<IQuadDestination>;\n}\n"]}