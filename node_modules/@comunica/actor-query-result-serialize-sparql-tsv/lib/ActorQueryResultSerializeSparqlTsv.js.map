{"version":3,"file":"ActorQueryResultSerializeSparqlTsv.js","sourceRoot":"","sources":["ActorQueryResultSerializeSparqlTsv.ts"],"names":[],"mappings":";;;AAEA,qFAE8C;AAG9C,mDAA8C;AAC9C,qDAA2C;AAE3C;;GAEG;AACH,MAAa,kCAAmC,SAAQ,qEAAwC;IAC9F;;;;;;;;OAQG;IACH,YAAmB,IAAmD;QACpE,KAAK,CAAC,IAAI,CAAC,CAAC;IACd,CAAC;IAED;;;;OAIG;IACI,MAAM,CAAC,oBAAoB,CAAC,KAAgB;QACjD,IAAI,CAAC,KAAK,EAAE;YACV,OAAO,EAAE,CAAC;SACX;QAED,qDAAqD;QACrD,OAAO,IAAA,6BAAY,EAAC,KAAK,CAAC;aACvB,OAAO,CAAC,MAAM,EAAE,KAAK,CAAC;aACtB,OAAO,CAAC,MAAM,EAAE,KAAK,CAAC;aACtB,OAAO,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;IAC5B,CAAC;IAEM,KAAK,CAAC,iBAAiB,CAAC,MAA8B,EAAE,OAAuB;QACpF,IAAI,MAAM,CAAC,IAAI,KAAK,UAAU,EAAE;YAC9B,MAAM,IAAI,KAAK,CAAC,8CAA8C,CAAC,CAAC;SACjE;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAEM,KAAK,CAAC,SAAS,CAAC,MAA8B,EAAE,SAA6B,EAAE,OAAuB;QAE3G,MAAM,cAAc,GAAmC,MAAM,CAAC;QAE9D,MAAM,IAAI,GAAG,IAAI,0BAAQ,EAAE,CAAC;QAC5B,IAAI,CAAC,KAAK,GAAG,GAAG,EAAE;YAChB,aAAa;QACf,CAAC,CAAC;QAEF,aAAa;QACb,MAAM,QAAQ,GAAG,MAAM,cAAc,CAAC,QAAQ,EAAE,CAAC;QACjD,IAAI,CAAC,IAAI,CAAC,GAAG,QAAQ,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,QAAsB,EAAE,EAAE,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAEhG,iBAAiB;QACjB,cAAc,CAAC,cAAc,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,KAAY,EAAE,EAAE;YACzD,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;QAC5B,CAAC,CAAC,CAAC;QACH,cAAc,CAAC,cAAc,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,QAAkB,EAAE,EAAE;YAC9D,IAAI,CAAC,IAAI,CAAC,GAAG,QAAQ,CAAC,SAAS;iBAC5B,GAAG,CAAC,CAAC,GAAiB,EAAE,EAAE,CAAC,kCAAkC;iBAC3D,oBAAoB,CAAC,QAAQ,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC;iBAC1C,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACrB,CAAC,CAAC,CAAC;QACH,cAAc,CAAC,cAAc,CAAC,EAAE,CAAC,KAAK,EAAE,GAAG,EAAE;YAC3C,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClB,CAAC,CAAC,CAAC;QAEH,OAAO,EAAE,IAAI,EAAE,CAAC;IAClB,CAAC;CACF;AAnED,gFAmEC","sourcesContent":["import type { IActionSparqlSerialize, IActorQueryResultSerializeFixedMediaTypesArgs,\n  IActorQueryResultSerializeOutput } from '@comunica/bus-query-result-serialize';\nimport {\n  ActorQueryResultSerializeFixedMediaTypes,\n} from '@comunica/bus-query-result-serialize';\nimport type { Bindings, IActionContext, IQueryOperationResultBindings } from '@comunica/types';\nimport type * as RDF from '@rdfjs/types';\nimport { termToString } from 'rdf-string-ttl';\nimport { Readable } from 'readable-stream';\n\n/**\n * A comunica SPARQL TSV Query Result Serialize Actor.\n */\nexport class ActorQueryResultSerializeSparqlTsv extends ActorQueryResultSerializeFixedMediaTypes {\n  /**\n   * @param args -\n   *   \\ @defaultNested {{\n   *       \"text/tab-separated-values\": 0.75\n   *     }} mediaTypePriorities\n   *   \\ @defaultNested {{\n   *       \"text/tab-separated-values\": \"http://www.w3.org/ns/formats/SPARQL_Results_TSV\"\n   *     }} mediaTypeFormats\n   */\n  public constructor(args: IActorQueryResultSerializeFixedMediaTypesArgs) {\n    super(args);\n  }\n\n  /**\n   * Converts an RDF term to its TSV representation.\n   * @param {RDF.Term} value An RDF term.\n   * @return {string} A string representation of the given value.\n   */\n  public static bindingToTsvBindings(value?: RDF.Term): string {\n    if (!value) {\n      return '';\n    }\n\n    // Escape tab, newline and carriage return characters\n    return termToString(value)\n      .replace(/\\t/gu, '\\\\t')\n      .replace(/\\n/gu, '\\\\n')\n      .replace(/\\r/gu, '\\\\r');\n  }\n\n  public async testHandleChecked(action: IActionSparqlSerialize, context: IActionContext): Promise<boolean> {\n    if (action.type !== 'bindings') {\n      throw new Error('This actor can only handle bindings streams.');\n    }\n    return true;\n  }\n\n  public async runHandle(action: IActionSparqlSerialize, mediaType: string | undefined, context: IActionContext):\n  Promise<IActorQueryResultSerializeOutput> {\n    const bindingsAction = <IQueryOperationResultBindings> action;\n\n    const data = new Readable();\n    data._read = () => {\n      // Do nothing\n    };\n\n    // Write head\n    const metadata = await bindingsAction.metadata();\n    data.push(`${metadata.variables.map((variable: RDF.Variable) => variable.value).join('\\t')}\\n`);\n\n    // Write bindings\n    bindingsAction.bindingsStream.on('error', (error: Error) => {\n      data.emit('error', error);\n    });\n    bindingsAction.bindingsStream.on('data', (bindings: Bindings) => {\n      data.push(`${metadata.variables\n        .map((key: RDF.Variable) => ActorQueryResultSerializeSparqlTsv\n          .bindingToTsvBindings(bindings.get(key)))\n        .join('\\t')}\\n`);\n    });\n    bindingsAction.bindingsStream.on('end', () => {\n      data.push(null);\n    });\n\n    return { data };\n  }\n}\n"]}