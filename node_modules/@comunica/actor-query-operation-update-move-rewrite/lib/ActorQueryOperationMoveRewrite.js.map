{"version":3,"file":"ActorQueryOperationMoveRewrite.js","sourceRoot":"","sources":["ActorQueryOperationMoveRewrite.ts"],"names":[],"mappings":";;;AACA,uEAAsG;AAItG,qDAA0C;AAE1C;;;GAGG;AACH,MAAa,8BAA+B,SAAQ,sDAA8C;IAGhG,YAAmB,IAA2C;QAC5D,KAAK,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;QACpB,IAAI,CAAC,OAAO,GAAG,IAAI,yBAAO,EAAE,CAAC;IAC/B,CAAC;IAEM,KAAK,CAAC,aAAa,CAAC,SAAuB,EAAE,OAAuB;QACzE,yCAAmB,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QAC7C,OAAO,IAAI,CAAC;IACd,CAAC;IAEM,YAAY,CAAC,iBAA+B,EAAE,OAAuB;QAC1E,kCAAkC;QAClC,IAAI,CAAC,OAAO,iBAAiB,CAAC,WAAW,KAAK,QAAQ,IAAI,OAAO,iBAAiB,CAAC,MAAM,KAAK,QAAQ;YAClG,iBAAiB,CAAC,WAAW,KAAK,iBAAiB,CAAC,MAAM,CAAC;YAC7D,CAAC,OAAO,iBAAiB,CAAC,WAAW,KAAK,QAAQ,IAAI,OAAO,iBAAiB,CAAC,MAAM,KAAK,QAAQ;gBAChG,iBAAiB,CAAC,WAAW,CAAC,MAAM,CAAC,iBAAiB,CAAC,MAAM,CAAC,CAAC,EAAE;YACnE,OAAO,OAAO,CAAC,OAAO,CAAC;gBACrB,IAAI,EAAE,MAAM;gBACZ,OAAO,EAAE,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE;aACjC,CAAC,CAAC;SACJ;QAED,+DAA+D;QAC/D,MAAM,OAAO,GAAG;YACd,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,iBAAiB,CAAC,WAAW,EAAE,IAAI,CAAC;YAC5D,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,iBAAiB,CAAC,MAAM,EAAE,iBAAiB,CAAC,WAAW,EAAE,iBAAiB,CAAC,MAAM,CAAC;YACzG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,iBAAiB,CAAC,MAAM,CAAC;SAClD,CAAC;QACF,MAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,qBAAqB,CAAC,OAAO,CAAC,CAAC;QAC9D,OAAO,IAAI,CAAC,sBAAsB,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE,OAAO,EAAE,CAAC,CAAC;IACrE,CAAC;CACF;AAlCD,wEAkCC","sourcesContent":["import type { IActorQueryOperationTypedMediatedArgs } from '@comunica/bus-query-operation';\nimport { ActorQueryOperation, ActorQueryOperationTypedMediated } from '@comunica/bus-query-operation';\nimport type { IActorTest } from '@comunica/core';\nimport type { IActionContext, IQueryOperationResult } from '@comunica/types';\nimport type { Algebra } from 'sparqlalgebrajs';\nimport { Factory } from 'sparqlalgebrajs';\n\n/**\n * A [Query Operation](https://github.com/comunica/comunica/tree/master/packages/bus-query-operation) actor that\n * handles SPARQL move operations.\n */\nexport class ActorQueryOperationMoveRewrite extends ActorQueryOperationTypedMediated<Algebra.Move> {\n  private readonly factory: Factory;\n\n  public constructor(args: IActorQueryOperationTypedMediatedArgs) {\n    super(args, 'move');\n    this.factory = new Factory();\n  }\n\n  public async testOperation(operation: Algebra.Move, context: IActionContext): Promise<IActorTest> {\n    ActorQueryOperation.throwOnReadOnly(context);\n    return true;\n  }\n\n  public runOperation(operationOriginal: Algebra.Move, context: IActionContext): Promise<IQueryOperationResult> {\n    // No-op if source === destination\n    if ((typeof operationOriginal.destination === 'string' && typeof operationOriginal.source === 'string' &&\n        operationOriginal.destination === operationOriginal.source) ||\n      (typeof operationOriginal.destination !== 'string' && typeof operationOriginal.source !== 'string' &&\n        operationOriginal.destination.equals(operationOriginal.source))) {\n      return Promise.resolve({\n        type: 'void',\n        execute: () => Promise.resolve(),\n      });\n    }\n\n    // MOVE is equivalent to drop destination, add, and drop source\n    const updates = [\n      this.factory.createDrop(operationOriginal.destination, true),\n      this.factory.createAdd(operationOriginal.source, operationOriginal.destination, operationOriginal.silent),\n      this.factory.createDrop(operationOriginal.source),\n    ];\n    const operation = this.factory.createCompositeUpdate(updates);\n    return this.mediatorQueryOperation.mediate({ operation, context });\n  }\n}\n"]}